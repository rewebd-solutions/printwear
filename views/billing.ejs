<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/placeorder.css">
    <link rel="stylesheet" href="/css/billing.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
        integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
    <link href='https://fonts.googleapis.com/css?family=Nunito' rel='stylesheet'>
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta3/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <title>Shipping</title>
</head>

<body>
    <div class="banner">
        <%- include('partials/side-logo.ejs') %>
            <%- include('partials/top.ejs') %>
    </div>
    <div class="order-wrapper">
        <div class="progressbar">
            <h2>Confirm Billing</h2>
        </div>
        <div class="steps" data-aos="fade-up">
            <div class="stp">
                <i class="fa-solid fa-briefcase"></i>
                <p>Order</p>
                <i class="fa-solid fa-arrow-right"></i>
            </div>
            <div class="stp">
                <i class="fa-solid fa-truck active-step"></i>
                <p class="active-step">Billing</p>
                <i class="fa-solid fa-arrow-right"></i>
            </div>
            <div class="stp">
                <i class="fa-solid fa-circle-check"></i>
                <p>Review</p>
            </div>
        </div>
        <% if (orderData.items.length > 0) { %>
            <div class="create-order-container" data-aos="fade-up">
                <div class="order-details">
                    <h3>Order Summary:</h3>
                    <ul class="orders-list">
                        <% designsData.forEach(design => { %>
                            <% const data = orderData.items.find(order => order.designId + "" == design._id + "") %>
                            <% if (data) { %>
                                <li>
                                    <img width="100" height="100" src="<%= design.designImage.front ? design.designImage.front: design.designImage.back  %>" alt="" />
                                    <h4><%= design.designName %> • <%= design.product.name %> </h4>
                                    <h4><%= data.quantity %> pcs </h4>
                                    <h4>₹.<%= data.price %> </h4>
                                </li>
                            <% } %>
                        <% }) %>
                    </ul>
                </div>
                <div class="retail-order-form">
                    <!-- <h3>Billing Address:</h3> -->
                    <div class="form-group">
                        <div>
                            <label for="customerOrderId">Your order ID:</label>
                            <input type="text" id="customerOrderId" placeholder="Order ID must be 10 characters long" title="Order ID must be 10 characters long!" name="customerOrderId" required>
                        </div>
        
                        <div>
                            <label for="retailPrice">Retail Price:</label>
                            <input type="text" id="retailPrice" name="retailPrice" required>
                        </div>
                    </div>
                </div>
                <div class="billing-address-form">
                    <h3>Billing Address:</h3>
                    <div class="form-group">
                        <div>
                            <label for="firstName">First name:</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
    
                        <div>
                            <label for="lastName">Last name:</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <div>
                            <label for="mobile">Mobile:</label>
                            <input type="text" pattern="^[789]\d{9}$" id="mobile" name="mobile" required>
                        </div>
    
                        <div>
                            <label for="email">Email:</label>
                            <input type="email" id="email" part="^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$" name="email" required>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="streetLandmark">Street, Landmark:</label>
                        <input type="text" id="streetLandmark" name="streetLandmark" required>
                    </div>
                    <div class="form-group">
                        <div>
                            <label for="city">City:</label>
                            <input type="text" id="city" name="city" required>
                        </div>
    
                        <div>
                            <label for="pincode">Pincode:</label>
                            <input type="text" id="pincode" pattern="[1-9][0-9]{5}" name="pincode" required>
                        </div>
                    </div>
    
                    <div class="form-group full-width">
                        <label for="state">State:</label>
                        <select id="state" name="state" required>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                            <option value="Chandigarh">Chandigarh</option>
                            <option value="Dadra and Nagar Haveli">Dadra and Nagar Haveli</option>
                            <option value="Daman and Diu">Daman and Diu</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Lakshadweep">Lakshadweep</option>
                            <option value="Puducherry">Puducherry</option>
                        </select>
                    </div>
    
                    <div class="form-group full-width">
                        <label for="country">Country:</label>
                        <input type="text" id="country" name="country" value="India" disabled>
                    </div>
                </div>
                <div class="bill-summary">
                    <div class="left-bill">
                        <h3>Bill total: </h3>
                    </div>
                    <div class="right-bill">
                        <h4>₹.<%= orderData.totalAmount %> </h4>
                        <h4>₹.0.00 (Tax)</h4>
                        <h4 id="shipping-charges">₹.0.00 (Shipping charges) </h4>
                        <hr />
                        <h4 id="total-charges">₹.<%= orderData.totalAmount %></h4>
                    </div>
                </div>
                <button type="button" id="btn-checkout">
                    Proceed to checkout
                </button>
            </div>
            <% } else { %>
            <h2> Oops! You don't have anything in your cart! </h2>
        <% } %>
    </div>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <% var totalPrice = orderData.totalAmount %>;
    <script>
        AOS.init();
        var notyf = new Notyf();
        var ttlp = "<%= totalPrice %>";
        var disabled = false;
        var orderIdVerified = false;
        var retailVerified = false;

        const cashfree = Cashfree({
            mode: "sandbox" //or production
        });

        const pincode = document.querySelector("#pincode");
        const orderIdInput = document.querySelector("input#customerOrderId");
        const retailPriceInput = document.querySelector("input#retailPrice");

        retailPriceInput.oninput = (e) => {
            let string = e.target.value;
            e.target.value = string.replace(/ /g, '').replace(/[^.0-9-_]/g, '');
            if (e.target.value.length < ttlp.split(".")[0].length) return retailVerified = false;
            // check if the number of digits in design price and retail price are same and then check if it is greater or not
            if (parseFloat(e.target.value) <= parseFloat(ttlp)) {
                retailVerified = false;
                return notyf.error("Retail price is less than billing total!");
            } else {
                retailVerified = true;
                return notyf.success("Retail price set✅");
            }
        }

        const checkOrderID = async (orderId) => {
            try {
                const checkOrderIDRequest = await fetch ("/checkorderid", { 
                    method: "POST",
                    body: JSON.stringify({
                        customerOrderId: orderId
                    }),
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
                const checkOrderIDResponse = await checkOrderIDRequest.json();
                if (checkOrderIDRequest.ok) {
                    return true;
                }
                return false;
            } catch (error) {
                console.log(error);
                notyf.error("Something went wrong in checking Order ID");
                return true; // i return true bcs dont want customer to get stuck bcs of internal server error
            }
        }

        orderIdInput.oninput = async (e) => {
            let string = e.target.value;
            e.target.value = string.replace(/ /g, '-').replace(/[^a-zA-Z0-9-_]/g, '').toUpperCase().slice(0, 10);
            if (e.target.value.length == 10) {
                e.target.setAttribute("disabled", true);
                if (await checkOrderID(e.target.value)) {
                    e.target.removeAttribute("disabled");
                    orderIdVerified = true;
                    return notyf.success("Order ID is verified");
                }
                orderIdVerified = false;
                e.target.removeAttribute("disabled");
                return notyf.error("Order ID is repeated. Please enter unique Order ID");
            }
        }

        pincode.oninput = async (e) => {
            if (e.target.value.length == 6) {
                e.target.setAttribute("disabled", true);
                if (await checkPincode(e.target.value)) {
                    notyf.success("Pincode verified successfully");
                    try {
                        const shippingChargesRequest = await fetch("/calculateshippingcharges", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                weight: 0.25,
                                pincode: e.target.value
                            })
                        });
                        shippingChargesResponse = await shippingChargesRequest.json();
                        // console.log(shippingChargesResponse)
                        if (!shippingChargesRequest.ok) return notyf.error("Couldn't calculate shipping charges! " + shippingChargesResponse.message);
                        document.getElementById("shipping-charges").innerHTML = `₹.${shippingChargesResponse.message} (Shipping charges)`;
                        document.getElementById("total-charges").innerHTML = `₹.${(parseFloat(ttlp) + shippingChargesResponse.message).toFixed(2)}`;
                    } catch (error) {
                        console.log(error);
                        notyf.error("Something went wrong in veriyfing PINCODE");
                    } finally {
                        e.target.removeAttribute("disabled");
                    }
                }
            }
        }

        const checkPincode = async (pincode) => {
            try {
                const pincodeRequest = await fetch("https://api.postalpincode.in/pincode/" + pincode);
                const pincodeResponse = await pincodeRequest.json();
                // console.log(pincodeResponse);
                if (pincodeResponse[0].Status == "Success") return true;
                return false;
            } catch (error) {
                console.log(error);
                notyf.error("Something went wrong in verifying PINCODE");
                return false;
            }
        }
        
        const checkoutBtn = document.querySelector("#btn-checkout");
        checkoutBtn.addEventListener("click", async (e) => {
            if (disabled) return;
            disabled = true;
            e.target.classList.add("disabled");
            
            if (!orderIdVerified || !retailVerified) {
                disabled = false;
                e.target.classList.remove("disabled");
                return notyf.error("Please check Order ID and Retail Price");
            }

            const formsData = document.querySelectorAll(".billing-address-form input");
            
            for(const inputItem of formsData){
                inputItem.style.outline = "none";
                if (!inputItem.reportValidity()) {
                    disabled = false;
                    e.target.classList.remove("disabled");
                    return notyf.error("Check " + inputItem.id);
                }             
            }

            const pincode = document.querySelector("#pincode");

            if (await checkPincode(pincode.value)) {
                notyf.success("Pincode verified!");
                const addressData = {
                    firstName: formsData[0].value,
                    lastName: formsData[1].value,
                    mobile: formsData[2].value,
                    email: formsData[3].value,
                    streetLandmark: formsData[4].value,
                    city: formsData[5].value,
                    pincode: formsData[6].value,
                    state: document.querySelector('#state').value,
                    country: formsData[7].value,
                    retailPrice: retailPriceInput.value,
                    customerOrderId: orderIdInput.value
                }
                try {
                    const createPaymentLinkRequest = await fetch("/createpaymentlink", {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(addressData),
                        method: 'POST'
                    });
                    const createPaymentLinkResponse = await createPaymentLinkRequest.json();
                    if (!createPaymentLinkRequest.ok) return notyf.error(createPaymentLinkResponse.message);
                    cashfree.checkout({ paymentSessionId: createPaymentLinkResponse.link }).then(check => console.log(check)).catch(err => notyf.error(error) );
                    //location.replace(`https://payments-test.cashfree.com/order/#${createPaymentLinkResponse.link}`);
                } catch (error) {
                    console.log(error);
                    disabled = false;
                    notyf.error("Something went wrong!");
                }
            } else {
                disabled = false;
                e.target.classList.remove("disabled");
                notyf.error("Check pincode");
            }

        });

    </script>
</body>

</html>