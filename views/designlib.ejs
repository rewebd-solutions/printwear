<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Import Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Import custom CSS file -->
  <link rel="stylesheet" href="/css/designlib.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta3/css/all.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
  <title>Design Library - Printwear</title>
</head>

<body>

  <!-- navbar -->
  <!-- Navbar starts here -->
  <div class="banner">
    <%- include('partials/side-logo.ejs') %>
      <%- include('partials/top.ejs') %>
  </div>
  <!-- navbar  -->


  <main class="product-lib">
    <div class="heading-row">
      <h2>Design Library</h2>
      <p>Start creating your designs and save them for reordering quickly.<br>
        You can also push them to your online store once you connect your store with Printwear</p>
    </div>
 
    <div class="designs-wrapper">
      <span class="loader"></span>
    </div>
  </main>

  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script>
    AOS.init();
    var notyf = new Notyf();

    const designsContainer = document.querySelector(".designs-wrapper");
    var designsResponseData = {};

    const disableButton = (buttonElement, innerTextBefore, innerTextAfter, state) => {
      state? buttonElement.setAttribute("disabled", true) : buttonElement.removeAttribute("disabled");
      state? buttonElement.classList.add("disabled"): buttonElement.classList.remove("disabled");
      state? buttonElement.innerHTML = `${innerTextBefore}` : buttonElement.innerHTML = `<i class="fa-regular fa-page"></i> ${innerTextAfter}`;
    }
    
    const deleteDesign = async (e, designSKU) => {
      disableButton(e.target, "Deleting...", "Deleted", true);
      try {
        const deleteDesignRequest = await fetch("/deletedesign", {
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            designSKU
          }),
          method:'POST'
        });
        const deleteDesignResponse = await deleteDesignRequest.text();
        notyf.success({
          message: "Design deleted successfully",
          dismissible: true,
          duration: 5000
        })
        document.querySelector("main").removeChild(document.querySelector(".product-modal-wrapper"))
        fetchDesignsData();
      } catch (error) {
        console.log(error);
        return notyf.error("Unable to delete design")
      }
    }
 
    const addToShopify = async (e, designSKU) => {
      disableButton(e.target, "Adding...", "Added to Shopify", true);
      try {
        const addToshopifyRequest = await fetch("/createshopifyproduct", {
          headers: {
            "Content-Type": "application/json"
          },
          method: "POST",
          body: JSON.stringify({
            designSKU
          }),
        });
        const addToshopifyResponse = await addToshopifyRequest.text();
        if (!addToshopifyRequest.ok) {
          document.querySelector("main").removeChild(document.querySelector(".product-modal-wrapper"))
          return notyf.error({
            message: "Shopify store not connected!",
            dismissible: true,
            duration: 5000
          }) 
        }
        notyf.success({
          message: "Added to shopify Store!",
          dismissible: true,
          duration: 5000
        })
        document.querySelector("main").removeChild(document.querySelector(".product-modal-wrapper"))
      } catch (error) {
        console.log(error);
        notyf.error("Something went wrong!");
      }
    }

    const addToWooCommerce = async (e, designSKU) => {
      disableButton(e.target, "Adding...", "Added to WooCommerce", true);
      try {
        const addToWoocommerceRequest = await fetch("/createwoocommerceorder", {
          headers: {
            "Content-Type": "application/json"
          },
          method: "POST",
          body: JSON.stringify({
            designSKU
          }),
        });
        const addToWoocommerceResponse = await addToWoocommerceRequest.json();
        if (!addToWoocommerceRequest.ok){
          document.querySelector("main").removeChild(document.querySelector(".product-modal-wrapper"))
          return notyf.error({
            message: "WooCommerce store not connected!",
            dismissible: true,
            duration: 5000
          }) 
        } 
        notyf.success({
          message: "Added to WooCommerce Store!",
          dismissible: true,
          duration: 5000
        })
        document.querySelector("main").removeChild(document.querySelector(".product-modal-wrapper"))
      } catch (error) {
        console.log(error);
        notyf.error("Something went wrong!");
      }
    }
    
    const openModal = (designSKU) => {
      const designModalData = designsResponseData.designs.find(designData => designData.designSKU === designSKU);
      console.log(designModalData);
      const designModalDOMString = `
        <div class="product-modal-wrapper">
          <div class="product-modal" data-aos="fade-up">
            <button class="modal-close">
              <i class="fa fa-close"></i>
            </button>
            <div class="product-modal-image">
              <img
                src="${designModalData.designImage.front}"
                alt="Design front image">
            </div>
            <div class="product-modal-details">
              <div class="product-modal-heading-delete">
                <h2 class="product-name">${designModalData.designName}</h2>
                <button id="delete-design" onclick="deleteDesign(event,'${designSKU}')"><i class="fa fa-trash"></i>Delete design</button>
              </div>
              <div class="product-category-gender">
                <h6>${designModalData.product.style}</h6>
                <h6>${designModalData.product.name}</h6>
              </div> 
              <p class="product-description">
                ${/*designModalData.product.description*/''}
                User generated design
              </p>
              <div class="product-colors">
                <p>Chosen color: </p>
                <div style="background:#ebebeb;">${designModalData.product.color}</div>
              </div>
              <div class="product-sizes">
                <p>Size: ${designModalData.product.size}</p>
              </div>
              <div class="product-price-button">
                <h4>Price â‚¹${designModalData.price}</h4>
                <button id='add-shopify' onclick="addToShopify(event,'${designSKU}')">Add to Shopify Store</button>
                <button id='add-woocommerce' onclick="addToWooCommerce(event,'${designSKU}')">Add to WooCommerce Store</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.querySelector("main").insertAdjacentHTML("beforeend", designModalDOMString);

      const closeModalButton = document.querySelector(".modal-close");
      closeModalButton.addEventListener("click", (e) => {
        document.querySelector("main").removeChild(document.querySelector(".product-modal-wrapper"))
      })
    }

    const createDesignCards = () => {
      const designCardsDOMString = designsResponseData.designs.map(design => {
        return `
          <div class="design-card" data-aos="fade-up">
            <div class="card-img">
              <img src="${ design.designImage.front != ''? design.designImage.front: design.designImage.back }">
            </div>
            <div class="name-price">
              <h3>${design.designName}</h3>
            </div>
            <div class="details">
              <div class="view-btn">
                <button onclick="openModal('${design.designSKU}')">View</button>
              </div>
            </div>
          </div>
        `
      }).join('\n');
      designsContainer.innerHTML = designCardsDOMString;

      /* designsContainer.addEventListener("click", (e) => {
        const openModalButton = e.target.closest(".view-btn button");
        if (openModalButton) {
          openModal(openModalButton.dataset.designid);
        }
      }) */
    }

    const fetchDesignsData = async () => {
      try {
        const designsFetchRequest = await fetch("/getdesigns");
        designsResponseData = await designsFetchRequest.json();

        console.log(designsResponseData);

        if (designsResponseData.designs.length > 0) {
          return createDesignCards();
        }
        designsContainer.innerHTML = "<p> No designs yet! </p>";
      } catch (error) {
        designsContainer.innerHTML = `
          <p>
            There was an error trying to fetch data. <br>
            ${error}
          </p>
        `;
        console.log(error);
      }
    }

    fetchDesignsData();
  </script>

</body>

</html>